<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HomeOffice Planer – by Torsten Zapp 2025</title>
  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel zum Kompilieren von JSX im Browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind (CDN) für Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#fafafa]">
  <div id="root"></div>

  <script type="text/babel">
    // ========= HomeOffice Planer (Browser-Version, keine externen Build-Tools) =========
    // by Torsten Zapp 2025

    // ---------- Helpers ----------
    const LS_KEY = "homeoffice-planer-v4"; // Versionierung für localStorage

    const ymd = (d) => d.toISOString().slice(0, 10);

    const getMonthDays = (year, month /* 0-11 */) => {
      const first = new Date(year, month, 1);
      const out = [];
      let d = new Date(first);
      while (d.getMonth() === month) {
        out.push(new Date(d));
        d.setDate(d.getDate() + 1);
      }
      return out;
    };

    const isWorkday = (d) => {
      const dow = d.getDay(); // 0 So, 1 Mo, ...
      return dow >= 1 && dow <= 5; // Mo–Fr
    };

    const monthLabel = (y, m) => new Date(y, m, 1).toLocaleDateString("de-DE", { month: "long", year: "numeric" });

    const keyFor = (personId, date) => `${personId}|${ymd(date)}`;

    const cls = (...xs) => xs.filter(Boolean).join(" ");

    /** @typedef {"HO"|"Büro"|"Urlaub"|"Krank"|"AZ"} Status */

    // ---------- App ----------
    function App() {
      const today = new Date();
      const [store, setStore] = React.useState(() => {
        try {
          const raw = localStorage.getItem(LS_KEY);
          if (raw) return JSON.parse(raw);
        } catch {}
        return {
          persons: [{ id: (crypto.randomUUID?.() || String(Math.random())), name: "Torsten", zielQuote: 40 }],
          /** @type {Record<string, Status|undefined>} */
          entries: {}, // `${personId}|YYYY-MM-DD` -> Status
        };
      });

      const [activePersonId, setActivePersonId] = React.useState(() => store.persons[0]?.id || "");
      const [year, setYear] = React.useState(today.getFullYear());
      const [month, setMonth] = React.useState(today.getMonth()); // 0-11

      const [showAdd, setShowAdd] = React.useState(false);
      const [newName, setNewName] = React.useState("");
      const [newQuote, setNewQuote] = React.useState("");

      React.useEffect(() => {
        localStorage.setItem(LS_KEY, JSON.stringify(store));
      }, [store]);

      React.useEffect(() => {
        if (!store.persons.find((p) => p.id === activePersonId)) {
          setActivePersonId(store.persons[0]?.id || "");
        }
      }, [store.persons, activePersonId]);

      const days = React.useMemo(() => getMonthDays(year, month), [year, month]);
      const activePerson = store.persons.find((p) => p.id === activePersonId) || null;

      const stats = React.useMemo(() => {
        if (!activePerson) return { workdays: 0, ho: 0, buero: 0, urlaub: 0, krank: 0, az: 0, basis: 0, pct: 0 };
        let workdays = 0, ho = 0, buero = 0, urlaub = 0, krank = 0, az = 0;
        for (const d of days) {
          if (!isWorkday(d)) continue;
          workdays++;
          /** @type {Status|undefined} */
          const st = store.entries[keyFor(activePerson.id, d)];
          if (st === "HO") ho++;
          else if (st === "Büro") buero++;
          else if (st === "Urlaub") urlaub++;
          else if (st === "Krank") krank++;
          else if (st === "AZ") az++;
        }
        const basis = ho + buero; // Nur diese zählen für die Quote
        const pct = basis ? Math.round((ho / basis) * 1000) / 10 : 0; // 1 Nachkommastelle
        return { workdays, ho, buero, urlaub, krank, az, basis, pct };
      }, [activePerson, days, store.entries]);

      /**
       * leer → HO → Büro → Urlaub → Krank → AZ → leer
       * @param {Status|undefined} cur
       * @returns {Status|undefined}
       */
      const cycle = (cur) => {
        if (cur === undefined) return "HO";
        if (cur === "HO") return "Büro";
        if (cur === "Büro") return "Urlaub";
        if (cur === "Urlaub") return "Krank";
        if (cur === "Krank") return "AZ";
        return undefined; // von AZ zurück zu leer
      };

      const setStatus = (date) => {
        if (!activePerson) return;
        const k = keyFor(activePerson.id, date);
        setStore((prev) => ({
          ...prev,
          entries: { ...prev.entries, [k]: cycle(prev.entries[k]) },
        }));
      };

      const clearMonth = () => {
        if (!activePerson) return;
        const prefix = `${activePerson.id}|`;
        const ymdPrefix = `${year}-${String(month + 1).padStart(2, "0")}-`;
        const entries = { ...store.entries };
        Object.keys(entries).forEach((k) => {
          if (k.startsWith(prefix) && k.includes(ymdPrefix)) delete entries[k];
        });
        setStore((prev) => ({ ...prev, entries }));
      };

      const addPerson = () => {
        const name = newName.trim();
        if (!name) return;
        const q = newQuote ? Math.max(0, Math.min(100, Number(newQuote))) : undefined;
        const p = { id: (crypto.randomUUID?.() || String(Math.random())), name, zielQuote: isFinite(q) ? q : undefined };
        setStore((prev) => ({ ...prev, persons: [...prev.persons, p] }));
        setNewName("");
        setNewQuote("");
        setShowAdd(false);
        setActivePersonId(p.id);
      };

      const removePerson = (id) => {
        const entries = { ...store.entries };
        const prefix = `${id}|`;
        Object.keys(entries).forEach((k) => { if (k.startsWith(prefix)) delete entries[k]; });
        setStore((prev) => ({ entries, persons: prev.persons.filter((p) => p.id !== id) }));
      };

      const exportJSON = () => {
        const blob = new Blob([JSON.stringify(store, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `homeoffice-planer_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const importJSON = (file) => {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(String(reader.result));
            if (data && Array.isArray(data.persons) && typeof data.entries === "object") {
              setStore(data);
            } else {
              alert("Ungültige Datei");
            }
          } catch {
            alert("Konnte Datei nicht lesen");
          }
        };
        reader.readAsText(file);
      };

      const prevMonth = () => {
        const d = new Date(year, month, 1);
        d.setMonth(d.getMonth() - 1);
        setYear(d.getFullYear());
        setMonth(d.getMonth());
      };
      const nextMonth = () => {
        const d = new Date(year, month, 1);
        d.setMonth(d.getMonth() + 1);
        setYear(d.getFullYear());
        setMonth(d.getMonth());
      };

      return (
        <div className="min-h-screen bg-[#fafafa] text-slate-900 p-4 md:p-8">
          <div className="mx-auto max-w-6xl space-y-6">
            {/* Header */}
            <header className="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
              <div>
                <h1 className="text-3xl font-semibold tracking-tight">HomeOffice Planer</h1>
                <p className="text-sm text-slate-500">Hell & freundlich · Monatsquote pro Person</p>
                <p className="text-xs text-slate-400">by Torsten Zapp 2025</p>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={exportJSON} className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50">Export</button>
                <label className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 cursor-pointer">
                  Import
                  <input type="file" accept="application/json" className="hidden" onChange={(e) => e.target.files?.[0] && importJSON(e.target.files[0])} />
                </label>
              </div>
            </header>

            {/* Layout */}
            <div className="grid grid-cols-1 md:grid-cols-[320px,1fr] gap-6">
              {/* Sidebar */}
              <aside className="space-y-4">
                <div className="rounded-2xl border bg-white p-4">
                  <h2 className="text-base font-medium mb-3">Kollegen</h2>
                  <select value={activePersonId} onChange={(e) => setActivePersonId(e.target.value)} className="w-full border rounded-xl px-3 py-2 bg-white">
                    {store.persons.map((p) => (
                      <option key={p.id} value={p.id}>{p.name}{typeof p.zielQuote === 'number' ? ` · Ziel ${p.zielQuote}%` : ''}</option>
                    ))}
                  </select>

                  <div className="flex items-center justify-between mt-3 text-sm">
                    <span className="text-slate-600">Aktiv: <b>{activePerson?.name || '—'}</b></span>
                    {activePerson && (
                      <button onClick={() => removePerson(activePerson.id)} className="text-red-600 hover:underline">Entfernen</button>
                    )}
                  </div>

                  {/* Add person */}
                  {!showAdd ? (
                    <button onClick={() => setShowAdd(true)} className="mt-3 w-full px-3 py-2 rounded-xl border bg-white hover:bg-slate-50">Kollegen hinzufügen</button>
                  ) : (
                    <div className="mt-3 grid gap-2">
                      <input value={newName} onChange={(e) => setNewName(e.target.value)} placeholder="Name" className="border rounded-xl px-3 py-2 bg-white" />
                      <input value={newQuote} onChange={(e) => setNewQuote(e.target.value)} placeholder="Ziel-Quote (%) – optional" inputMode="numeric" className="border rounded-xl px-3 py-2 bg-white" />
                      <div className="flex gap-2">
                        <button onClick={addPerson} className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50">Hinzufügen</button>
                        <button onClick={() => { setShowAdd(false); setNewName(""); setNewQuote(""); }} className="px-3 py-2 rounded-xl border">Abbrechen</button>
                      </div>
                    </div>
                  )}
                </div>

                <div className="rounded-2xl border bg-white p-4">
                  <h2 className="text-base font-medium mb-3">Monatsübersicht</h2>
                  <div className="flex items-center justify-between mb-2">
                    <button onClick={prevMonth} className="px-3 py-2 rounded-xl border bg-white">‹</button>
                    <div className="font-medium">{monthLabel(year, month)}</div>
                    <button onClick={nextMonth} className="px-3 py-2 rounded-xl border bg-white">›</button>
                  </div>

                  <div className="text-sm text-slate-600 space-y-1">
                    <div className="flex items-center justify-between"><span>HO-Tage</span><span className="font-medium">{stats.ho}</span></div>
                    <div className="flex items-center justify-between"><span>Büro-Tage</span><span className="font-medium">{stats.buero}</span></div>
                    <div className="flex items-center justify-between"><span>Urlaub</span><span className="font-medium">{stats.urlaub}</span></div>
                    <div className="flex items-center justify-between"><span>Krank</span><span className="font-medium">{stats.krank}</span></div>
                    <div className="flex items-center justify-between"><span>AZ</span><span className="font-medium">{stats.az}</span></div>
                    <div className="flex items-center justify-between"><span>Werktage gesamt</span><span className="font-medium">{stats.workdays}</span></div>
                    <div className="flex items-center justify-between"><span>Quote-Basis (HO+Büro)</span><span className="font-medium">{stats.basis}</span></div>
                  </div>

                  <div className="space-y-2 mt-2">
                    <div className="flex items-center justify-between text-sm"><span>Homeoffice-Quote</span><span className="font-semibold">{stats.pct}%</span></div>
                    <div className="w-full h-3 rounded-full bg-slate-100 overflow-hidden">
                      <div className="h-full bg-emerald-400" style={{ width: `${Math.min(100, Math.max(0, stats.pct))}%` }} />
                    </div>
                    {typeof activePerson?.zielQuote === 'number' && (
                      <div className="text-xs text-slate-500">Ziel: {activePerson.zielQuote}%</div>
                    )}
                  </div>

                  <button onClick={clearMonth} className="mt-3 w-full px-3 py-2 rounded-xl border bg-white hover:bg-slate-50">Monat leeren</button>
                </div>
              </aside>

              {/* Main Calendar */}
              <section>
                <div className="rounded-2xl border bg-white">
                  <div className="p-4 border-b">
                    <h2 className="text-base font-medium">Kalender – {monthLabel(year, month)}</h2>
                  </div>
                  <div className="p-4">
                    <div className="grid grid-cols-7 text-xs font-medium text-slate-500 mb-2">
                      {["Mo","Di","Mi","Do","Fr","Sa","So"].map((w) => (
                        <div key={w} className="px-2 py-1">{w}</div>
                      ))}
                    </div>
                    <div className="grid grid-cols-7 gap-2">
                      {(() => {
                        const nodes = [];
                        const first = new Date(year, month, 1);
                        let isoOffset = first.getDay() - 1; // Mo-Start
                        if (isoOffset < 0) isoOffset = 6;
                        for (let i = 0; i < isoOffset; i++) nodes.push(<div key={`b${i}`} />);

                        for (const d of days) {
                          const disabled = !isWorkday(d);
                          const k = activePerson ? keyFor(activePerson.id, d) : "";
                          /** @type {Status|undefined} */
                          const st = activePerson ? store.entries[k] : undefined;

                          const ring = st === "HO"
                            ? "ring-emerald-400"
                            : st === "Büro"
                            ? "ring-sky-400"
                            : st === "Urlaub"
                            ? "ring-amber-400"
                            : st === "Krank"
                            ? "ring-rose-400"
                            : st === "AZ"
                            ? "ring-violet-400"
                            : "";

                          nodes.push(
                            <button
                              key={ymd(d)}
                              onClick={() => !disabled && setStatus(d)}
                              className={cls(
                                "rounded-2xl border p-2 text-left transition-all min-h-[84px] bg-white",
                                "border-slate-200 hover:shadow-sm",
                                disabled && "opacity-60",
                                st && `ring-2 ${ring}`,
                              )}
                              title={disabled ? "Wochenende" : "Klicken: leer → HO → Büro → Urlaub → Krank → AZ → leer"}
                            >
                              <div className="flex items-center justify-between mb-2">
                                <div className="text-xs text-slate-500">{d.toLocaleDateString("de-DE", { weekday: "short" })}</div>
                                <div className="text-sm font-semibold">{d.getDate()}</div>
                              </div>
                              <div className="flex gap-1 items-center text-xs flex-wrap">
                                {st === "HO" && <span className="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200">Homeoffice</span>}
                                {st === "Büro" && <span className="px-2 py-0.5 rounded-full bg-sky-100 text-sky-700 border border-sky-200">Büro</span>}
                                {st === "Urlaub" && <span className="px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 border border-amber-200">Urlaub</span>}
                                {st === "Krank" && <span className="px-2 py-0.5 rounded-full bg-rose-100 text-rose-700 border border-rose-200">Krank</span>}
                                {st === "AZ" && <span className="px-2 py-0.5 rounded-full bg-violet-100 text-violet-700 border border-violet-200">AZ</span>}
                                {!st && !disabled && <span className="text-slate-400">–</span>}
                                {disabled && <span className="text-slate-400">Wochenende</span>}
                              </div>
                            </button>
                          );
                        }
                        return nodes;
                      })()}
                    </div>

                    <div className="mt-4 text-xs text-slate-500 space-y-1">
                      <p>Klicke auf einen Werktag, um zwischen <b>leer → Homeoffice → Büro → Urlaub → Krank → AZ → leer</b> zu wechseln.</p>
                      <p>Die Homeoffice-Quote zählt nur Tage mit <b>HO</b> oder <b>Büro</b>.</p>
                    </div>
                  </div>
                </div>
              </section>
            </div>

            <footer className="text-center text-xs text-slate-400 py-4">
              © {new Date().getFullYear()} HomeOffice Planer · by Torsten Zapp 2025 · heller, freundlicher Stil
            </footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
